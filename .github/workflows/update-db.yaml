name: update-db
on: 
  push:
    branches:
      - master
  workflow_dispatch:
  schedule:
    - cron:  '0 2 * * *'

concurrency: 
  group: repo-update
  cancel-in-progress: false

jobs:
  update-db:
    runs-on: ubuntu-latest
    container:
      image: docker://manjarolinux/build:latest
    steps:
      - name: check out the repo
        id: checkout_repo
        uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # v3.3.0
      - name: setup
        run: |
          git config --global --add safe.directory /__w/packages/packages
      - name: gpg-init
        run: |
          # import signing key (no passphrase)
          cat <(echo -e "${{ secrets.GPG_SECRET_KEY_BASE64 }}" | base64 --decode) | gpg --batch --import
          pacman-key --keyserver keyserver.ubuntu.com --recv-keys ${{ secrets.GPG_KEYID }}
          pacman-key --lsign-key ${{ secrets.GPG_KEYID }}
      - name: update the repo with all currently present packages
        id: update_repo
        run: |
          mkdir -p docs/x86_64 docs/aarch64
          git config --global user.name "Repo Update Bot"
          git config --global user.email "info@manjaro-sway.download"
          git config pull.ff only

          git pull

          rm -f docs/*/manjaro-sway.db.* docs/*/manjaro-sway.files.*

          repo-add --sign docs/x86_64/manjaro-sway.db.tar.gz
          repo-add --sign docs/aarch64/manjaro-sway.db.tar.gz
          
          repo-add --sign --new --remove --prevent-downgrade docs/x86_64/manjaro-sway.db.tar.gz docs/x86_64/*.zst || echo 'no new packages'
          repo-add --sign --new --remove --prevent-downgrade docs/aarch64/manjaro-sway.db.tar.gz docs/aarch64/*.zst || echo 'no new packages'

          rm -f docs/**/*.old* || echo 'no .old files found'
          date >docs/_includes/date
          git add docs/**/*
          
          size=$(du -sb docs/x86_64/manjaro-sway.db.tar.gz | awk '{ print $1 }')
          if ((size<10000)) ; then
            echo "db is too small";
            exit 1;
          fi

          git commit -m "chore: update pkg databases"
          git push
