name: repo-add
on:
  repository_dispatch:
    types: [package_update]

jobs:
  repo-add:
    runs-on: ubuntu-latest
    container:
      image: docker://manjarolinux/build:latest
    steps:
      - uses: ben-z/gh-action-mutex@v1.0-alpha-6
      - name: check out the repo
        id: checkout_repo
        uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # v3.3.0
        with:
          ref: 'main'
      - name: setup
        run: |
          git config --global --add safe.directory /__w/packages/packages
          sudo pacman -Sy --noconfirm --needed github-cli
      - name: check if the repo was allowed to dispatch
        id: grant
        env:
          REPO: ${{ github.event.client_payload.repository }}
        run:
          grep -Fxq "${REPO}" allowed_repos
      - name: download the package to be added to the repo
        id: download_release
        run: |
          echo ${{ github.token }} | gh auth login --with-token
          gh release download ${{ github.event.client_payload.version }} --repo ${{ github.event.client_payload.repository }} -D /tmp/
          ls -lh /tmp/*.zst*
      - name: gpg-init
        run: |
          # import signing key (no passphrase)
          cat <(echo -e "${{ secrets.GPG_SECRET_KEY_BASE64 }}" | base64 --decode) | gpg --batch --import
          pacman-key --keyserver keyserver.ubuntu.com --recv-keys ${{ secrets.GPG_KEYID }}
          pacman-key --lsign-key ${{ secrets.GPG_KEYID }}
      - name: update the existing repo with the downloaded package
        id: update_repo
        run: |
          git config --global user.name "Repo Update Bot"
          git config --global user.email "info@manjaro-sway.download"

          TARGET_DIR=""
          [[ "${{ github.event.client_payload.version }}" =~ ^testing ]] && TARGET_DIR="testing"
          [[ "${{ github.event.client_payload.version }}" =~ ^unstable ]] && TARGET_DIR="unstable"

          AMD64_PATH="docs/${TARGET_DIR}/x86_64/"
          AARCH64_PATH="docs/${TARGET_DIR}/aarch64/"

          mkdir -p $AMD64_PATH $AARCH64_PATH

          cp -f /tmp/*-x86_64* $AMD64_PATH || cp -f /tmp/*-aarch64* $AARCH64_PATH || cp -f /tmp/*-any* $AMD64_PATH || cp -f /tmp/*-any* $AARCH64_PATH

          if [ -n "$(git status --porcelain)" ]; then
            rm -f $AMD64_PATH/manjaro-sway.db* $AMD64_PATH/manjaro-sway.files*
            rm -f $AARCH64_PATH/manjaro-sway.db* $AARCH64_PATH/manjaro-sway.files*

            repo-add --sign --new --remove --prevent-downgrade $AMD64_PATH/manjaro-sway.db.tar.gz $AMD64_PATH/*.zst || \
            repo-add --sign --new --remove --prevent-downgrade $AARCH64_PATH/manjaro-sway.db.tar.gz $AARCH64_PATH/*.zst

            rm -f docs/**/*.old* || echo 'no .old files found'
            git add docs/**/*

            git commit -m "chore: update ${{ github.event.client_payload.repository }} (${{ github.event.client_payload.version }})"
            git push
          fi
      - uses: peter-evans/repository-dispatch@26b39ed245ab8f31526069329e112ab2fb224588 # v2
        with:
          event-type: new_release
