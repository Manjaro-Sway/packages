name: repo-add
on:
  repository_dispatch:
    types: [package_update]

concurrency: 
  group: repo-add
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    container:
      image: docker://manjarolinux/build:latest
    steps:
      - uses: ben-z/gh-action-mutex@v1.0-alpha-6
      - name: check out the repo
        id: checkout_repo
        uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8 # v3.1.0
        with:
          ref: 'master'
      - name: setup
        run: |
          git config --global --add safe.directory /__w/packages/packages
      - name: check if the repo was allowed to dispatch
        id: grant
        env:
          REPO: ${{ github.event.client_payload.repository }}
        run:
          grep -Fxq "${REPO}" allowed_repos
      - name: download the package to be added to the repo
        id: download_release
        env:
          REPO: ${{ github.event.client_payload.repository }}
          VERSION: ${{ github.event.client_payload.version }}
          FILE: ${{ github.event.client_payload.file_name }}
        run: |
          curl --location --remote-header-name --remote-name --silent -O --output-dir /tmp \
            https://github.com/$REPO/releases/download/$VERSION/$FILE
          curl --location --remote-header-name --remote-name --silent -O --output-dir /tmp \
            https://github.com/$REPO/releases/download/$VERSION/${FILE}.sig
          ls -lh /tmp/*.zst*
      - name: gpg-init
        run: |
          # import signing key (no passphrase)
          cat <(echo -e "${{ secrets.GPG_SECRET_KEY_BASE64 }}" | base64 --decode) | gpg --batch --import
          pacman-key --keyserver keyserver.ubuntu.com --recv-keys ${{ secrets.GPG_KEYID }}
          pacman-key --lsign-key ${{ secrets.GPG_KEYID }}
      - name: update the existing repo with the downloaded package
        id: update_repo
        run: |
          mkdir -p docs/x86_64 docs/aarch64
          git config --global user.name "Repo Update Bot"
          git config --global user.email "info@manjaro-sway.download"
          git config pull.ff only
          git pull 

          echo ${{ github.event.client_payload.file_name }} | grep -q -E -i -w '(x86_64|any)' && \
            cp /tmp/${{ github.event.client_payload.file_name }}* docs/x86_64/ && \
            echo "nothing to do for x86_64"


          echo ${{ github.event.client_payload.file_name }} | grep -q -E -i -w '(aarch64|any)' && \
            cp /tmp/${{ github.event.client_payload.file_name }}* docs/aarch64/ && \
              echo "nothing to do for aarch64"

          if [ -n "$(git status --porcelain)" ]; then

            echo ${{ github.event.client_payload.file_name }} | grep -q -E -i -w '(x86_64|any)' && \
              repo-add --sign --new --remove --prevent-downgrade docs/x86_64/manjaro-sway.db.tar.gz docs/x86_64/${{ github.event.client_payload.file_name }} && \
              echo "nothing to do for x86_64"

            echo ${{ github.event.client_payload.file_name }} | grep -q -E -i -w '(aarch64|any)' && \
              repo-add --sign --new --remove --prevent-downgrade docs/aarch64/manjaro-sway.db.tar.gz docs/aarch64/${{ github.event.client_payload.file_name }} && \
              echo "nothing to do for aarch64"

            rm -f docs/*/*.old

            cp -f README.md docs/index.md

            date >docs/_includes/date

            git add docs/*
                      
            git commit -m "chore: update ${{ github.event.client_payload.repository }} (${{ github.event.client_payload.file_name }})"
            git push
          fi
                    
          
